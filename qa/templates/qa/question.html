{% extends 'web/base.html' %}
{% load i18n %}
{% load static %}
{% block title %}{{ question.title }}{% endblock title %}
{% block content %}
    {% include 'web/common/header_top.html' with heading=question.title %}
    <div class="row">
        <div class="col">
            <div class="question-body">
                {{ question.body_html|safe }}
            </div>
        </div>
    </div>

    <div class="row pb-5">
        <div class="col-md-3">
            {% include 'web/common/render_vote.html' with type='Question' pk=question.id %}
        </div>
        <div class="col-md-3 mt-3">
            {% if question.user == request.user or 'edit_question_and_answer' in user.profile.privilages %}
                <a href="{% url 'qa:question_edit' question.id %}" class="brand-color-link">{% trans "Edit" %}</a>
            {% endif %}
        </div>
        <div class="col-md-6">
            {% include 'web/common/render_user_compact.html' with user=question.user info_date=question.created %}
        </div>
    </div>

    <div class="row pt-3 pb-3 border border-primary text-white bg-primary">
        <div class="col">
            {% trans "Number of answer: " %} {{ question.answer_set.count }}
        </div>
    </div>
    
    <div>
        {% for ans in question.answer_set.all %}
            <div class="row mt-5">
                <div class="col">
                    {{ ans.body_html|safe }}
                </div>
            </div>

            <div class="row border-bottom pb-5">
                <div class="col-md-3">
                    {% include 'web/common/render_vote.html' with type='Answer' pk=ans.id obj=ans %}
                </div>
                <div class="col-md-3 mt-3">
                    {% if ans.user == request.user or 'edit_question_and_answer' in user.profile.privilages %}
                        <a href="{% url 'qa:answer_edit' question.id ans.id %}" class="brand-color-link">{% trans "Edit" %}</a>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    {% include 'web/common/render_user_compact.html' with  user=ans.user info_date=ans.created %}
                </div>
            </div>
        {% endfor %}
    </div>

    {% if request.user.is_authenticated %}
    <div class="row mt-3">
        <div class="col">
            <h3>{% trans "Your Answer" %}</h3>
            <form action="{% url 'qa:submit_answer' question.id %}" method="post">
                {% csrf_token %}
                <div class="mb-3">
                    <div class="row">
                        <div class="col">
                            <div>
                                <input id="x" type="hidden" name="body_html"/>
                                <trix-editor input="x"></trix-editor>
                            </div>
                        </div>
                    </div>
                    <h3 class="mt-3">{% trans "Preview:" %}</h3>
                    <div class="row">
                        <div class="col mt-3">
                            <div id="preview"></div>  
                        </div>
                    </div>
                </div>
                <input class="btn btn-primary mb-3" type="submit" value="{% trans "Post your answer" %}">
            </form>
        </div>
    </div>
    {% endif %}
{% endblock content %}
{% block css %}
    <link rel="stylesheet" href="{% static 'css/trix.css' %}">
{% endblock css %}
{% block js %}
    {% if user.is_authenticated %}
    <script src="{% static 'js/trix.js' %}"></script>
    {% endif %}
    <script type="text/javascript">
        {% if user.is_authenticated %}
        (function () {
            var editorValue = document.getElementById("x");
            var divPreview = document.getElementById("preview");
            divPreview.innerHTML = editorValue.value;
            
            addEventListener("trix-change", function (e) {
                divPreview.innerHTML = editorValue.value;
            });
        
        })();
        {% endif %}
        // Example POST method implementation:
        async function postData(url = '', data = {}) {
            // Default options are marked with *
            const response = await fetch(url, {
                method: 'POST', // *GET, POST, PUT, DELETE, etc.
                mode: 'cors', // no-cors, *cors, same-origin
                cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
                credentials: 'same-origin', // include, *same-origin, omit
                headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': Cookies.get('csrftoken')
                },
                redirect: 'follow', // manual, *follow, error
                referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
                body: JSON.stringify(data) // body data type must match "Content-Type" header
            });
            return response.json(); // parses JSON response into native JavaScript objects
        }

        function btnVoteUp(type, id){
            if (type === 'Question'){
                postData('{% url "qa:question_vote_up" question.id %}', {})
                    .then(data => {
                        if (data.status === 'ok') {
                            var btnVoteValue = document.getElementById('btnVoteValue');
                            btnVoteValue.innerHTML = data.vote;
                        }
                    });
            }
            if (type === 'Answer'){
                console.log('Not Implemented method')
            }
        }

        function btnVoteDownClick(type, id){
            if (type === 'Question'){
                postData('{% url "qa:question_vote_down" question.id %}', {})
                    .then(data => {
                        console.log(data); // JSON data parsed by `data.json()` call
                        if (data.status === 'ok') {
                            var btnVoteValue = document.getElementById('btnVoteValue');
                            btnVoteValue.innerHTML = data.vote;
                        }
                    });
            }
            if (type === 'Answer'){
                console.log('Not Implemented method')
            }
        }
    </script>
{% endblock %}